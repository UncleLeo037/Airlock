[gd_scene load_steps=5 format=3 uid="uid://4apqf4scie4p"]

[ext_resource type="PackedScene" uid="uid://c7ru4s3rig3kr" path="res://scenes/player_model.tscn" id="1_3vyb7"]

[sub_resource type="GDScript" id="GDScript_u8vuu"]
resource_name = "player"
script/source = "extends CharacterBody3D;

const SPEED : float = 5.0;
const JUMP_VELOCITY : float = 5.0;
const SENSITIVITY : float = 0.08;

@onready var head : CollisionShape3D = $CollisionShape3D;
@onready var camera : Camera3D = $CollisionShape3D/Camera3D;
@onready var ray : RayCast3D = $CollisionShape3D/Camera3D/RayCast3D;
@onready var mark : Marker3D = $CollisionShape3D/Camera3D/Marker3D;
@onready var shape : RayCast3D = $RayCast3D;

var object : CollisionObject3D;
var weight : float;

enum states {paused, crouching, idle, jumping, sneaking, walking, running, sliding, hoping, leaping}

var state : states = states.idle

func _ready() -> void:
	if not is_multiplayer_authority(): return;
	
	#mouse mode is being used like bool for if player is controlable or in menu
	Input.mouse_mode = Input.MOUSE_MODE_CAPTURED;
	camera.current = true;
	
func _unhandled_input(event: InputEvent) -> void:
	if not is_multiplayer_authority(): return;
	
	if event.is_action_pressed(\"interact\"):
		interact();
	
	if event is InputEventMouseMotion and Input.get_mouse_mode() == Input.MOUSE_MODE_CAPTURED:
		head.rotate_y(deg_to_rad(-event.relative.x * SENSITIVITY));
		camera.rotate_x(deg_to_rad(-event.relative.y * SENSITIVITY));
		camera.rotation.x = clamp(camera.rotation.x, deg_to_rad(-90), deg_to_rad(90));

func _physics_process(delta: float) -> void:
	if not is_multiplayer_authority(): return;
	
	if ray.get_collider() is RigidBody3D:
		$HUD/Label.show();
	else:
		$HUD/Label.hide();
	
	# Add the gravity.
	if not is_on_floor():
		velocity += get_gravity() * delta;

	# Handle jump.
	if Input.is_action_just_pressed(\"jump\") and is_on_floor():
		velocity.y = JUMP_VELOCITY;
	
	if Input.is_action_pressed(\"crouch\"):
		camera.position.y = 0.3;
	
	if Input.is_action_just_released(\"crouch\"):
		camera.position.y = 0.6;
	
	# Get the input direction and handle the movement/deceleration.
	# As good practice, you should replace UI actions with custom gameplay actions.
	var input_dir := Input.get_vector(\"left\", \"right\", \"forward\", \"backward\");
	var direction := (head.transform.basis * Vector3(input_dir.x, 0, input_dir.y)).normalized();
	var totalSpeed : float = SPEED;
	if input_dir.y < 0:
		totalSpeed += float(Input.is_action_pressed(\"sprint\")) * 3.0;
	if direction and Input.get_mouse_mode() == Input.MOUSE_MODE_CAPTURED:
		velocity.x = direction.x * totalSpeed;
		velocity.z = direction.z * totalSpeed;
	else:
		velocity.x = move_toward(velocity.x, 0, totalSpeed);
		velocity.z = move_toward(velocity.z, 0, totalSpeed);
	
	match state:
		states.walking:
			totalSpeed = SPEED
			
	
	move_and_slide();
	
	#calls object manipulation function if holding object
	if object:
		manipulate();

func manipulate() -> void:
	if head.global_transform.origin.distance_to(object.global_transform.origin) > 3:
			interact();
	else:
		var a : Vector3 = object.global_transform.origin;
		var b : Vector3 = mark.global_transform.origin;
		var diff : Vector3 = (b-a)*10#*object.mass #adjust the multiplier here
		diff = diff.clamp(-Vector3.ONE*10, Vector3.ONE*10);
		object.linear_damp = 30 - diff.length();
		if shape.get_collider() == object:
			diff.y = 0;
		object.apply_impulse(diff);

func interact() -> void:
	if object:
		object.linear_damp = 0;
		object = null;
	elif ray.get_collider() is RigidBody3D:
		var cast : CollisionObject3D = ray.get_collider();
		object = cast;
"

[sub_resource type="CapsuleShape3D" id="CapsuleShape3D_u8vuu"]

[sub_resource type="SceneReplicationConfig" id="SceneReplicationConfig_u8vuu"]

[node name="CharacterBody3D" type="CharacterBody3D"]
script = SubResource("GDScript_u8vuu")

[node name="CollisionShape3D" type="CollisionShape3D" parent="."]
shape = SubResource("CapsuleShape3D_u8vuu")

[node name="PlayerModel" parent="CollisionShape3D" instance=ExtResource("1_3vyb7")]

[node name="Camera3D" type="Camera3D" parent="CollisionShape3D"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0.6, 0)

[node name="RayCast3D" type="RayCast3D" parent="CollisionShape3D/Camera3D"]
target_position = Vector3(0, 0, -2)

[node name="Marker3D" type="Marker3D" parent="CollisionShape3D/Camera3D"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, -1.5)

[node name="MultiplayerSynchronizer" type="MultiplayerSynchronizer" parent="."]
replication_config = SubResource("SceneReplicationConfig_u8vuu")

[node name="HUD" type="CanvasLayer" parent="."]

[node name="Label" type="Label" parent="HUD"]
visible = false
anchors_preset = 8
anchor_left = 0.5
anchor_top = 0.5
anchor_right = 0.5
anchor_bottom = 0.5
offset_left = -20.0
offset_top = -11.5
offset_right = 20.0
offset_bottom = 11.5
grow_horizontal = 2
grow_vertical = 2
size_flags_horizontal = 4
text = "E interact"
horizontal_alignment = 1
vertical_alignment = 1
